<div id="bars"></div>
<div id="volumes"></div>
<style>
  #bars, #volumes {
    height: 300px;
    display: flex;
    flex-flow: row-reverse;
    align-items: flex-end;
    justify-content: flex-start;
  }

  #bars .bar {
    width: 30px;
    background: green;
  }
  #bars .bar.sell {
    background: red;
    transform: translateY(100%);
  }
  #volumes .bar {
    width: 30px;
    transform: translateY(+50%);
    background: #04272a;
  }
</style>
<script>
  let buyVolumes = Array(60).fill(0);
  let buyList = Array(60).fill().map(() => []);
  let sellVolumes = Array(60).fill(0);
  let sellList = Array(60).fill().map(() => []);
  let bars = document.getElementById('bars');
  let volumes = document.getElementById('volumes');
  Array.from(Array(60).keys()).forEach((n) => {
    bars.appendChild(document.createElement('div'));
    bars.children[n].classList.add('bar');
    volumes.appendChild(document.createElement('div'));
    volumes.children[n].classList.add('bar');
  })


  console.log("START")
  let sock = new WebSocket("wss://api2.poloniex.com");

  sock.addEventListener('open', () => {
    console.log("CONNECTED")
    sock.send('{"command":"subscribe","channel":"BTC_ETH"}');
  });

  sock.addEventListener('close', () => {
    console.error("CLOSED")
  });

  sock.addEventListener('error', () => {
    console.error("ERROR")
  });

  sock.addEventListener('message', (msg) => {
    tx = JSON.parse(msg.data);
    if (tx[0] === 148) { // ETHBTC channel
      tx[2].forEach((event) => {
        if (event[0] === "t") { // Trade event
          amount = Number(event[3]) * Number(event[4]);
          timestamp = new Date(Number(event[5]) * 1000);


          if (event[2] === 1) { // Buy
            buyVolumes[0] += amount;
            buyList[0].push([timestamp, amount]);
          } else { // Sell
            sellVolumes[0] += amount;
            sellList[0].push([timestamp, amount]);
          }
        }
      })
    }

  });

  let update = () => {
    let now = new Date();
    let edge;
    Array.from(Array(60).keys()).forEach((n) => {
      let testDate =  new Date(now.getTime() - (n + 1) * 60000);
      while (true) {
        edge = buyList[n].shift();
        if (edge && edge[0] < testDate) {
          buyVolumes[n] -= edge[1];
          if (buyList[n + 1]) {
            buyVolumes[n + 1] += edge[1];
            buyList[n + 1].push(edge);
          }
        } else {
          if (edge) {
            buyList[n].unshift(edge);
          }
          break;
        }
      }
      while (true) {
        edge = sellList[n].shift();
        if (edge && edge[0] < testDate) {
          sellVolumes[n] -= edge[1];
          if (sellList[n + 1]) {
            sellVolumes[n + 1] += edge[1]
            sellList[n + 1].push(edge);
          }
        } else {
          if (edge) {
            sellList[n].unshift(edge);
          }
          break;
        }
      }
      let movement = buyVolumes[n] - sellVolumes[n]
      if (movement < 0) {
        bars.children[n].classList.add('sell');
      } else {
        bars.children[n].classList.remove('sell');
      }
      bars.children[n].style = `height:${Math.abs(movement)}px`

      let volumeBar = document.createElement('div');
      volumes.children[n].style = `height:${buyVolumes[n] + sellVolumes[n]}px`
    })
  }
  let loop = setInterval(update, 5000)
</script>
