<div id="movements"></div>
<div id="volumes"></div>
<div id="movementaverages"></div>
<div id="volumeaverages"></div>
<style>
  #movements, #volumes, #movementaverages, #volumeaverages {
    height: 200px;
    display: flex;
    flex-flow: row-reverse;
    align-items: flex-end;
    justify-content: flex-start;
  }

  .bar {
    width: 30px;
    background: green;
  }
  .bar.sell {
    background: red;
    transform: translateY(100%);
  }
  #volumes .bar, #volumeaverages .bar {
    background: #04272a;
    transform: translateY(+50%);
  }
</style>
<script>
  const MAXSIZE = 360;
  let buyVolumes = Array(MAXSIZE).fill(0);
  let buyList = Array(MAXSIZE).fill().map(() => []);
  let sellVolumes = Array(MAXSIZE).fill(0);
  let sellList = Array(MAXSIZE).fill().map(() => []);
  let movements = document.getElementById('movements');
  let volumes = document.getElementById('volumes');
  let movementaverages = document.getElementById('movementaverages');
  let volumeaverages = document.getElementById('volumeaverages');
  Array.from(Array(MAXSIZE).keys()).forEach((n) => {
    movements.appendChild(document.createElement('div'));
    movements.children[n].classList.add('bar');
    volumes.appendChild(document.createElement('div'));
    volumes.children[n].classList.add('bar');
    movementaverages.appendChild(document.createElement('div'));
    movementaverages.children[n].classList.add('bar');
    volumeaverages.appendChild(document.createElement('div'));
    volumeaverages.children[n].classList.add('bar');
  })


  console.log("START")
  let sock = new WebSocket("wss://api2.poloniex.com");

  sock.addEventListener('open', () => {
    console.log("CONNECTED")
    sock.send('{"command":"subscribe","channel":"BTC_ETH"}');
  });

  sock.addEventListener('close', () => {
    console.error("CLOSED")
  });

  sock.addEventListener('error', () => {
    console.error("ERROR")
  });

  sock.addEventListener('message', (msg) => {
    tx = JSON.parse(msg.data);
    if (tx[0] === 148) { // ETHBTC channel
      tx[2].forEach((event) => {
        if (event[0] === "t") { // Trade event
          amount = Number(event[3]) * Number(event[4]);
          timestamp = new Date(Number(event[5]) * 1000);


          if (event[2] === 1) { // Buy
            buyVolumes[0] += amount;
            buyList[0].push([timestamp, amount]);
          } else { // Sell
            sellVolumes[0] += amount;
            sellList[0].push([timestamp, amount]);
          }
        }
      })
    }

  });

  let update = () => {
    let now = new Date();
    let edge;
    Array.from(Array(360).keys()).forEach((n) => {
      let testDate =  new Date(now.getTime() - (n + 1) * 10000);
      while (true) {
        edge = buyList[n].shift();
        if (edge && edge[0] < testDate) {
          buyVolumes[n] -= edge[1];
          if (buyList[n + 1]) {
            buyVolumes[n + 1] += edge[1];
            buyList[n + 1].push(edge);
          }
        } else {
          if (edge) {
            buyList[n].unshift(edge);
          }
          break;
        }
      }
      while (true) {
        edge = sellList[n].shift();
        if (edge && edge[0] < testDate) {
          sellVolumes[n] -= edge[1];
          if (sellList[n + 1]) {
            sellVolumes[n + 1] += edge[1]
            sellList[n + 1].push(edge);
          }
        } else {
          if (edge) {
            sellList[n].unshift(edge);
          }
          break;
        }
      }
    })


    let movement = 0;
    let volume = 0;
    Array.from(Array(MAXSIZE + 20).keys()).forEach((n) => {
      movement += (buyVolumes[n] - sellVolumes[n])
      volume += (buyVolumes[n] + sellVolumes[n])
      if (n - 20 >= 0) {
        movement -= (buyVolumes[n - 20] - sellVolumes[n - 20])
        volume -= (buyVolumes[n - 20] + sellVolumes[n - 20])
        if (movement < 0) {
          movementaverages.children[n - 20].classList.add('sell');
        } else {
          movementaverages.children[n - 20].classList.remove('sell');
        }
        movementaverages.children[n - 20].style = `height:${Math.abs(movement * 3)}px`;
        volumeaverages.children[n - 20].style = `height:${volume * 3}px`;
      } else {
        movementaverages.children[0].style = `height:${Math.abs(movement * 3)}px`;
        volumeaverages.children[0].style = `height:${volume * 3}px`;
      }
      if (n < MAXSIZE) {
        movements.children[n].style = `height:${Math.abs(buyVolumes[n] - sellVolumes[n]) * 6}px`;
        if (buyVolumes[n] - sellVolumes[n] < 0) {
          movements.children[n].classList.add('sell')
        } else {
          movements.children[n].classList.remove('sell')
        }
        volumes.children[n].style = `height:${(buyVolumes[n] + sellVolumes[n]) * 6}px`;
      }
    })
  }
  let loop = setInterval(update, 5000)
</script>
